#!/bin/bash
if [[ `uname` == "Darwin" ]]; then
  if [[ $(ps -ef | grep "Emacs --daemon" | grep -v grep) == "" ]]; then
    /Applications/Emacs.app/Contents/MacOS/Emacs --daemon
  fi
  if test -n "$DISPLAY"; then
    SWITCHES='-n -c'
    if [[ "$1" == "-t" ]]; then
      SWITCHES='-t'
    fi
    if [[ $SWITCHES != '-t' ]]; then
      echo "${@:2}"
      /Applications/Emacs.app/Contents/MacOS/bin/emacsclient $SWITCHES "$@"
      exec osascript -e 'tell application "Emacs" to activate'
    else
      exec /Applications/Emacs.app/Contents/MacOS/bin/emacsclient $SWITCHES "${@:2}"
    fi
  else
    /Applications/Emacs.app/Contents/MacOS/bin/emacsclient -t "$@" 
  fi
else
  if [[ $(ps -ef | grep "emacs --daemon" | grep -v grep) == "" ]]; then
    /usr/bin/emacs --daemon
  fi
  if test -n "$DISPLAY"; then
    SWITCHES='-n -c'
    if [[ "$1" == "-t" ]]; then
      SWITCHES='-t'
    fi
    if [[ $SWITCHES != '-t' ]]; then
      emacsclient $SWITCHES "$@"
    else
      exec emacsclient $SWITCHES "${@:2}"
    fi
  else
    emacsclient -t "$@"
  fi
fi
